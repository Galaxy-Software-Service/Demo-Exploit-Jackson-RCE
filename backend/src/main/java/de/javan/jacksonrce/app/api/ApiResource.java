package de.javan.jacksonrce.app.api;

import java.io.IOException;
import java.io.InputStream;

import javax.ws.rs.Consumes;
import javax.ws.rs.GET;
import javax.ws.rs.POST;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;
import javax.xml.bind.annotation.XmlAccessType;
import javax.xml.bind.annotation.XmlAccessorType;

import org.glassfish.jersey.media.multipart.FormDataContentDisposition;
import org.glassfish.jersey.media.multipart.FormDataParam;
import org.springframework.beans.factory.InitializingBean;
import org.springframework.stereotype.Service;
import org.springframework.web.bind.annotation.CrossOrigin;

import com.fasterxml.jackson.databind.ObjectMapper;

@XmlAccessorType(XmlAccessType.NONE)
@Path("")
@Service
@Produces(MediaType.APPLICATION_JSON)
@CrossOrigin
public class ApiResource implements InitializingBean {

    @GET
    @Path("/test")
    public String test() {
        return "Hello world!";
    }
    
    @POST
    @Consumes(MediaType.MULTIPART_FORM_DATA)
    @Path("/files/upload")
    public Response uploadFile(@FormDataParam("file") InputStream file,
            @FormDataParam("file") FormDataContentDisposition fileDatail) {
    	
		ObjectMapper mapper = new ObjectMapper();
		mapper.enableDefaultTyping();
		
		try {
			Inner i = mapper.readValue(file, Inner.class);
			// do something with the JSON file
			return Response.ok(i).build();
			
		} catch (IOException e) {
			return Response.status(Response.Status.INTERNAL_SERVER_ERROR.getStatusCode(), e.toString()).build();
		}
		
    }
    
    @POST
    @Path("/list")
    public Response appendList(String newList) {
    	//newList: {\"age\":33,\"messages\":[\"msg 1\",\"msg 2\"],\"name\":\"mkyong\"}
    	
    	ObjectMapper mapper = new ObjectMapper();
		mapper.enableDefaultTyping();
		
		try {
			// Convert JSON string to Object
			Inner i = mapper.readValue(newList, Inner.class);
			
			return Response.ok(i).build();
			
		} catch (IOException e) {
			return Response.status(Response.Status.INTERNAL_SERVER_ERROR.getStatusCode(), e.toString()).build();
		}
		
    }
    
    @POST
    @Path("/users")
    public Response saveUser(User user) {

    	ObjectMapper mapper = new ObjectMapper();
		mapper.enableDefaultTyping();
		
		try {
			System.out.println(user);
			//Convert object to JSON string
			String jsonInString = mapper.writeValueAsString(user);
			System.out.println(jsonInString);
			
			User u = mapper.readValue(jsonInString, User.class);
			return Response.ok(u).build();
			
		} catch (IOException e) {
			return Response.status(Response.Status.INTERNAL_SERVER_ERROR.getStatusCode(), e.toString()).build();
		}
		
    }

    @Override
    public void afterPropertiesSet() throws Exception {

    }
}

class Inner {
	public int id;
	public Object obj;
}

class User {
	public String name;
	public Object phone;
}
